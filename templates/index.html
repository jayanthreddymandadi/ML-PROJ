<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Traffic Accident Severity Prediction</title>

  <!-- Google Fonts for 'Inter' -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Chart.js for the chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Inter', sans-serif;
      padding: 20px;
    }
    .container {
      background-color: #ffffff;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-top: 2rem;
      max-width: 1100px;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 1rem;
      font-weight: 700;
    }
    .abstract {
      text-align: center;
      color: #666;
      margin-bottom: 2rem;
    }
    .card-input {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.3s ease;
      background-color: #f9f9f9;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .card-input:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    .form-label {
      font-weight: 500;
      color: #444;
      margin-bottom: 0.5rem;
    }
    .form-label i {
      margin-right: 8px;
      color: #007bff;
    }
    .form-control {
      border-radius: 8px;
    }
    #map {
      width: 100%;
      height: 300px;
      border-radius: 15px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    .btn-primary {
      background-color: #007bff;
      border: none;
      border-radius: 10px;
      padding: 12px 25px;
      font-weight: bold;
      transition: background-color 0.3s, transform 0.2s;
    }
    .btn-primary:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }
    .result {
      text-align: center;
      padding: 1rem;
      border-radius: 10px;
      font-size: 1.25rem;
      font-weight: bold;
      margin-top: 2rem;
      color: #fff;
    }
    .result.low { background-color: #28a745; }
    .result.medium { background-color: #ffc107; }
    .result.high { background-color: #dc3545; }
    .result i {
      margin-right: 10px;
    }
    #threejsCanvas {
      width: 100%;
      height: 400px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-top: 15px;
      background-color: #f0f0f0;
    }
    #severityChart {
      background-color: #fafafa;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 1rem;
    }
    .chart-container {
      width: 100%;
      height: 300px;
      padding: 1rem;
    }
    .safety-box {
      border-left: 6px solid #007bff;
      padding: 15px;
      border-radius: 10px;
      background: #f9f9f9;
      margin-top: 15px;
    }
    .safety-box h5 {
      color: #007bff;
    }
    .safety-box.low {
      border-left-color: #28a745;
    }
    .safety-box.low h5 {
      color: #28a745;
    }
    .safety-box.medium {
      border-left-color: #ffc107;
    }
    .safety-box.medium h5 {
      color: #ffc107;
    }
    .safety-box.high {
      border-left-color: #dc3545;
    }
    .safety-box.high h5 {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>3D Traffic Accident Severity Prediction</h1>
    <p class="abstract">This tool predicts traffic accident severity based on user-defined parameters, including weather, road conditions, and location in New York City.</p>

    <form id="predictionForm" action="#" method="post" class="row g-3">
      
      <!-- Weather -->
      <div class="col-md-6">
        <div class="card card-input p-3">
          <label class="form-label"><i class="fas fa-cloud-sun"></i> Weather Conditions</label>
          <select class="form-control" name="weather">
            <option value="Clear" selected>Clear</option>
            <option value="Rain">Rain</option>
            <option value="Snow">Snow</option>
            <option value="Fog">Fog</option>
            <option value="Storm">Storm</option>
          </select>
        </div>
      </div>

      <!-- Road Surface Condition -->
      <div class="col-md-6">
        <div class="card card-input p-3">
          <label class="form-label"><i class="fas fa-road"></i> Road Surface Condition</label>
          <select class="form-control" name="road_surface">
            <option value="Dry" selected>Dry</option>
            <option value="Wet">Wet</option>
            <option value="Snow">Snow</option>
            <option value="Ice">Ice</option>
            <option value="Flooded">Flooded</option>
          </select>
        </div>
      </div>

      <!-- Time of Day -->
      <div class="col-md-6">
        <div class="card card-input p-3">
          <label class="form-label"><i class="fas fa-clock"></i> Time of Day</label>
          <select class="form-control" name="time">
            <option value="morning">Morning</option>
            <option value="afternoon">Afternoon</option>
            <option value="evening" selected>Evening</option>
            <option value="night">Night</option>
          </select>
        </div>
      </div>

      <!-- Traffic Density -->
      <div class="col-md-6">
        <div class="card card-input p-3">
          <label class="form-label"><i class="fas fa-car"></i> Traffic Density</label>
          <select class="form-control" name="traffic">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
      </div>

      <!-- Accident Type -->
      <div class="col-md-6">
        <div class="card card-input p-3">
          <label class="form-label"><i class="fas fa-car-crash"></i> Accident Type</label>
          <select class="form-control" name="accident_type">
            <option value="collision" selected>Collision</option>
            <option value="rollover">Rollover</option>
            <option value="pedestrian">Pedestrian</option>
            <option value="side-impact">Side Impact</option>
          </select>
        </div>
      </div>

      <!-- Date -->
      <div class="col-md-6">
        <div class="card card-input p-3">
          <label class="form-label"><i class="fas fa-calendar-alt"></i> Date</label>
          <input type="date" class="form-control" name="date" value="2025-08-24">
        </div>
      </div>

      <!-- Latitude -->
      <div class="col-md-6">
        <div class="card card-input p-3">
          <label class="form-label"><i class="fas fa-map-marker-alt"></i> Latitude</label>
          <input type="number" step="any" class="form-control" id="latitude" name="latitude" value="40.7128">
        </div>
      </div>

      <!-- Longitude -->
      <div class="col-md-6">
        <div class="card card-input p-3">
          <label class="form-label"><i class="fas fa-map-marker-alt"></i> Longitude</label>
          <input type="number" step="any" class="form-control" id="longitude" name="longitude" value="-74.0060">
        </div>
      </div>

      <!-- Map -->
      <div class="col-12">
        <div class="card card-input p-3">
          <label class="form-label"><i class="fas fa-map-marked-alt"></i> Select Location on NYC Map</label>
          <div id="map" style="width: 100%; height: 300px;"></div>
        </div>
      </div>

      <!-- Submit -->
      <div class="col-12 text-center">
        <button class="btn btn-primary mt-3" type="submit">Predict Severity</button>
      </div>
    </form>

    <!-- Prediction Result -->
    <div id="severityResult" class="result mt-3 d-none">
      <i class="fas fa-exclamation-triangle"></i> Predicted Severity: <span id="severityLevel">Medium</span>
    </div>

    <!-- Safety Suggestions -->
    <div class="safety-box" id="safetySuggestion">
      <h5><i class="fas fa-lightbulb"></i> Safety Suggestion</h5>
      <p id="suggestionText">Drive carefully, obey signals, and stay alert even in low-risk conditions.</p>
    </div>

    <!-- 3D Canvas -->
    <h2 class="mt-4 text-center">3D Visualization</h2>
    <div id="threejsCanvas"></div>

    <!-- Chart -->
    <h2 class="mt-4 text-center">Severity Probability</h2>
    <div class="chart-container mt-3">
      <canvas id="severityChart"></canvas>
    </div>
  </div>

  <script>
    // ========== Leaflet Map ==========
    // Initialize map centered on New York
    var map = L.map('map').setView([40.7128, -74.0060], 12);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Marker at default coordinates
    var marker = L.marker([40.7128, -74.0060]).addTo(map);

    // Function to update marker and inputs
    function updateMarker(lat, lng) {
      marker.setLatLng([lat, lng]);
      document.getElementById("latitude").value = lat.toFixed(6);
      document.getElementById("longitude").value = lng.toFixed(6);
      map.setView([lat, lng], 12);
    }

    // On map click, update marker and inputs
    map.on('click', function(e) {
      updateMarker(e.latlng.lat, e.latlng.lng);
    });

    // If user manually changes lat/lng, move marker
    document.getElementById("latitude").addEventListener("input", function() {
      var lat = parseFloat(this.value);
      var lng = parseFloat(document.getElementById("longitude").value);
      if (!isNaN(lat) && !isNaN(lng)) {
        updateMarker(lat, lng);
      }
    });

    document.getElementById("longitude").addEventListener("input", function() {
      var lat = parseFloat(document.getElementById("latitude").value);
      var lng = parseFloat(this.value);
      if (!isNaN(lat) && !isNaN(lng)) {
        updateMarker(lat, lng);
      }
    });

    // ========== Simple Prediction Logic ==========
    function predictSeverity() {
      const weather = document.querySelector('select[name="weather"]').value;
      const road_surface = document.querySelector('select[name="road_surface"]').value;
      const time = document.querySelector('select[name="time"]').value;
      const traffic = document.querySelector('select[name="traffic"]').value;
      const accident_type = document.querySelector('select[name="accident_type"]').value;

      let score = 0;
      // Assign points based on factors
      if (weather === 'Storm' || weather === 'Snow' || weather === 'Fog') score += 3;
      if (road_surface === 'Wet' || road_surface === 'Snow' || road_surface === 'Ice' || road_surface === 'Flooded') score += 2;
      if (time === 'night') score += 2;
      if (traffic === 'high') score += 2;
      if (accident_type === 'pedestrian' || accident_type === 'rollover') score += 3;

      let severity = 'Low';
      let severityClass = 'low';
      let suggestionText = "Drive carefully, obey signals, and stay alert even in low-risk conditions.";

      if (score >= 6) {
        severity = 'High';
        severityClass = 'high';
        suggestionText = "Avoid unnecessary travel, slow down significantly, and increase following distance.";
      } else if (score >= 3) {
        severity = 'Medium';
        severityClass = 'medium';
        suggestionText = "Reduce speed, maintain a safe distance, and be cautious on adverse road conditions.";
      }

      // Update the display
      const resultDisplay = document.getElementById('severityResult');
      const severityText = document.getElementById('severityLevel');
      
      severityText.textContent = severity;
      resultDisplay.className = `result mt-3 ${severityClass}`;
      resultDisplay.classList.remove('d-none'); // Show the result

      // Update the safety suggestion
      const safetyBox = document.getElementById('safetySuggestion');
      const safetyText = document.getElementById('suggestionText');
      safetyText.textContent = suggestionText;
      safetyBox.className = `safety-box mt-3 ${severityClass}`;

      // Update the chart
      updateSeverityChart(severity);

      // Update the 3D scene based on severity
      update3DVisualization(severity);
    }

    // ========== Chart.js Setup ==========
    let severityChart;
    function createSeverityChart() {
        const ctx = document.getElementById('severityChart').getContext('2d');
        severityChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Low', 'Medium', 'High'],
                datasets: [{
                    label: 'Predicted Probability',
                    data: [0, 0, 0], // Initial data
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(220, 53, 69, 0.7)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                          display: true,
                          text: 'Probability (%)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Severity Prediction Probability'
                    }
                }
            }
        });
    }

    // Function to update the chart data
    function updateSeverityChart(predictedSeverity) {
        const lowProb = (predictedSeverity === 'Low') ? 80 + Math.random() * 20 : 10 + Math.random() * 20;
        const mediumProb = (predictedSeverity === 'Medium') ? 60 + Math.random() * 40 : 10 + Math.random() * 20;
        const highProb = (predictedSeverity === 'High') ? 70 + Math.random() * 30 : 10 + Math.random() * 20;

        const total = lowProb + mediumProb + highProb;
        const data = [
            (lowProb / total) * 100,
            (mediumProb / total) * 100,
            (highProb / total) * 100
        ];

        severityChart.data.datasets[0].data = data;
        severityChart.update();
    }

    // ========== Three.js Setup and Animation ==========
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    
    // Set a transparent background for the renderer
    renderer.setClearColor(0x000000, 0); 

    // Create a pedestal for the cars to sit on
    const pedestalGeometry = new THREE.CylinderGeometry(1.5, 1.5, 0.2, 32);
    const pedestalMaterial = new THREE.MeshLambertMaterial({ color: 0xcccccc });
    const pedestal = new THREE.Mesh(pedestalGeometry, pedestalMaterial);
    scene.add(pedestal);

    // Create a light to see the models
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
    directionalLight.position.set(0, 5, 5);
    scene.add(directionalLight);

    // Create two simple car shapes
    const car1Geometry = new THREE.BoxGeometry(0.5, 0.3, 1);
    const car2Geometry = new THREE.BoxGeometry(0.5, 0.3, 1);
    
    const carMaterial = new THREE.MeshPhongMaterial({ color: 0x007bff });
    
    const car1 = new THREE.Mesh(car1Geometry, carMaterial);
    const car2 = new THREE.Mesh(car2Geometry, carMaterial);

    car1.position.set(-0.5, 0.2, 0);
    car2.position.set(0.5, 0.2, 0);
    
    scene.add(car1);
    scene.add(car2);
    
    camera.position.z = 3;

    // A simple animation loop to rotate the scene
    function animate() {
      requestAnimationFrame(animate);
      scene.rotation.y += 0.005;
      renderer.render(scene, camera);
    }
    
    // Function to update the 3D visualization based on severity
    function update3DVisualization(severity) {
      // Change the color of the cars and pedestal based on severity
      if (severity === 'Low') {
        pedestal.material.color.setHex(0x28a745);
        car1.position.set(-0.5, 0.2, 0);
        car2.position.set(0.5, 0.2, 0);
      } else if (severity === 'Medium') {
        pedestal.material.color.setHex(0xffc107);
        // Slightly move cars for a minor collision effect
        car1.position.set(-0.4, 0.2, 0.1);
        car2.position.set(0.4, 0.2, -0.1);
      } else { // High
        pedestal.material.color.setHex(0xdc3545);
        // More dramatic effect for a severe collision
        car1.position.set(-0.2, 0.2, 0.2);
        car2.position.set(0.2, 0.2, -0.2);
      }
    }

    // Form submission handler
    document.getElementById('predictionForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent default form submission
      predictSeverity();
    });

    // Handle window resize
    window.addEventListener('resize', () => {
        const parent = document.getElementById('threejsCanvas');
        const newWidth = parent.clientWidth;
        const newHeight = parent.clientHeight;

        camera.aspect = newWidth / newHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(newWidth, newHeight);
    });

    // Initialize the chart and three.js on page load
    window.onload = function() {
        createSeverityChart();
        const parent = document.getElementById('threejsCanvas');
        const width = parent.clientWidth;
        const height = parent.clientHeight;
        renderer.setSize(width, height);
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        parent.appendChild(renderer.domElement);
        animate();
    };
  </script>
</body>
</html>
